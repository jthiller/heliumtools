<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Helium DC Alerts – OUI Notifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; padding: 2rem; max-width: 760px; margin: 0 auto; background: #f8fafc; color: #0f172a; }
    h1 { font-size: 1.6rem; margin-bottom: 0.5rem; }
    h2 { margin: 0 0 0.4rem; font-size: 1.1rem; }
    p { margin: 0 0 0.75rem; color: #334155; }
    .panel, form { margin-top: 1rem; padding: 1.25rem; border-radius: 0.75rem; background: #fff; border: 1px solid #e2e8f0; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0f172a; }
    input, button { font-size: 0.95rem; }
    input { width: 100%; padding: 0.55rem 0.6rem; margin-bottom: 0.7rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background: #fff; }
    button { padding: 0.65rem 1.2rem; border-radius: 999px; border: none; cursor: pointer; background: #2563eb; color: #fff; font-weight: 600; }
    button:hover { background: #1d4ed8; }
    small { color: #475569; }
    .grid { display: grid; gap: 0.65rem; }
    .info-row { display: flex; gap: 0.35rem; align-items: baseline; }
    .info-label { font-weight: 600; color: #0f172a; min-width: 70px; }
    .info-value { color: #1f2937; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all; }
    .actions { display: flex; gap: 0.75rem; align-items: center; }
    .status { font-size: 0.9rem; color: #334155; }
    .status.error { color: #b91c1c; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .form-actions { margin-top: 1rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Helium Data Credit Alerts (OUI Notifier)</h1>
  <p>Get email (and optional webhook) alerts when your Helium DC escrow account is projected to run out within 14, 7, or 1 day based on recent burn.</p>
  <p><strong>Note:</strong> Data transfer halts when an escrow hits $35 (≈3,500,000 DC). Alerts and charts treat that as zero.</p>

  <section class="panel">
    <h2>Find your escrow by OUI</h2>
    <p>Lookup any on-chain OUI to view its payer, escrow address, and live DC balance.</p>
    <div class="grid">
      <div>
        <label for="oui_lookup">OUI</label>
        <input id="oui_lookup" type="number" name="oui_lookup" placeholder="e.g. 3" list="oui-list" form="subscribe_form" />
        <datalist id="oui-list"></datalist>
      </div>
      <div class="info-row">
        <span class="info-label">Escrow:</span>
        <a id="escrow_display" class="info-value mono" target="_blank" rel="noreferrer noopener"></a>
      </div>
      <div class="info-row">
        <span class="info-label">Payer:</span>
        <span id="payer_display" class="info-value mono"></span>
      </div>
      <div class="info-row">
        <span class="info-label">Balance:</span>
        <span id="balance_display" class="info-value mono"></span>
      </div>
      <div class="actions">
        <button type="button" id="check_balance">Check live DC balance</button>
        <div id="balance_status" class="status"></div>
      </div>
    </div>
  </section>

  <!-- The API endpoint is on the Worker at api.heliumtools.org -->
  <form id="subscribe_form" method="POST" action="https://api.heliumtools.org/oui-notifier/subscribe">
    <input id="escrow_field" class="hidden" type="text" name="escrow_account" required />

    <label for="email">Email address</label>
    <input id="email" name="email" type="email" required placeholder="you@example.com" />

    <label for="label">Label (optional)</label>
    <input id="label" name="label" type="text" placeholder="e.g. Prod IoT OUI" />

    <label for="webhook_url">Webhook URL (optional)</label>
    <input id="webhook_url" name="webhook_url" type="url" placeholder="https://example.com/helium-webhook" />

    <small>We store a daily balance snapshot, estimate your burn over the last 7 days, and email you when you’re about 14, 7, and 1 day from running out.</small>

    <div class="form-actions">
      <button type="submit">Subscribe</button>
    </div>
  </form>

  <script>
    (() => {
      const API_BASE = "https://api.heliumtools.org/oui-notifier";
      const ouiInput = document.getElementById("oui_lookup");
      const escrowDisplay = document.getElementById("escrow_display");
      const payerDisplay = document.getElementById("payer_display");
      const balanceDisplay = document.getElementById("balance_display");
      const statusEl = document.getElementById("balance_status");
      const checkBtn = document.getElementById("check_balance");
      const datalist = document.getElementById("oui-list");
      const escrowField = document.getElementById("escrow_field");
      const emailField = document.getElementById("email");
      let ouiIndex = [];

      function setStatus(text, isError = false) {
        statusEl.textContent = text || "";
        statusEl.className = `status${isError ? " error" : ""}`;
      }

      function hydrateDatalist(orgs) {
        datalist.innerHTML = "";
        orgs.forEach((org) => {
          const opt = document.createElement("option");
          opt.value = org.oui;
          opt.label = `OUI ${org.oui} • payer ${org.payer || "n/a"} • escrow ${org.escrow}`;
          datalist.appendChild(opt);
        });
      }

      function lookupOui(ouiNum) {
        const numericOui = Number(ouiNum);
        if (!Number.isInteger(numericOui)) return null;
        return ouiIndex.find((o) => o.oui === numericOui);
      }

      async function loadOuis() {
        try {
          const res = await fetch(`${API_BASE}/ouis`);
          if (!res.ok) throw new Error("failed to fetch OUIs");
          const data = await res.json();
          ouiIndex = Array.isArray(data.orgs) ? data.orgs : [];
          hydrateDatalist(ouiIndex);
        } catch (err) {
          console.error("Unable to load OUIs", err);
          setStatus("Unable to load OUI list right now.", true);
        }
      }

      async function fetchBalance(params) {
        const query = new URLSearchParams(params);
        const res = await fetch(`${API_BASE}/balance?${query.toString()}`);
        if (!res.ok) throw new Error("failed to fetch balance");
        return res.json();
      }

      function renderOrg(org) {
        payerDisplay.textContent = org?.payer || "";

        if (org?.escrow) {
          escrowDisplay.textContent = org.escrow;
          escrowDisplay.href = `https://solscan.io/account/${encodeURIComponent(org.escrow)}`;
          escrowDisplay.style.visibility = "visible";
          escrowField.value = org.escrow;
          localStorage.setItem("ouiNotifierEscrow", org.escrow);
        } else {
          escrowDisplay.textContent = "";
          escrowDisplay.removeAttribute("href");
          escrowDisplay.style.visibility = "hidden";
          escrowField.value = "";
          localStorage.removeItem("ouiNotifierEscrow");
        }
      }

      async function updateBalance() {
        const ouiValue = (ouiInput.value || "").trim();
        if (!ouiValue) {
          setStatus("Enter an OUI number.", true);
          return;
        }

        const match = lookupOui(ouiValue);
        renderOrg(match);

        setStatus("Fetching live balance…");
        balanceDisplay.textContent = "";
        try {
          const payload = await fetchBalance({ oui: ouiValue });
          if (payload.error) throw new Error(payload.error);
          if (payload.escrow) {
            escrowField.value = payload.escrow;
            escrowDisplay.textContent = payload.escrow;
            escrowDisplay.href = `https://solscan.io/account/${encodeURIComponent(payload.escrow)}`;
            escrowDisplay.style.visibility = "visible";
            localStorage.setItem("ouiNotifierEscrow", payload.escrow);
          }
          const usd = Number(payload.balance_usd || 0);
          const dc = Number(payload.balance_dc || 0);
          balanceDisplay.textContent = `${dc.toLocaleString("en-US")} DC / $${usd.toFixed(2)}`;
          setStatus(`Live balance retrieved for OUI ${ouiValue}.`);
        } catch (err) {
          console.error(err);
          setStatus("Could not fetch balance. Please try again.", true);
        }
      }

      ouiInput.addEventListener("change", () => {
        const match = lookupOui(ouiInput.value);
        renderOrg(match);
        if (match?.oui) {
          setStatus(`Loaded details for OUI ${match.oui}.`);
        } else {
          setStatus("");
          balanceDisplay.textContent = "";
        }
      });

      checkBtn.addEventListener("click", (ev) => {
        ev.preventDefault();
        updateBalance();
      });

      emailField.addEventListener("input", (ev) => {
        localStorage.setItem("ouiNotifierEmail", ev.target.value || "");
      });

      function loadSavedFields() {
        const savedEmail = localStorage.getItem("ouiNotifierEmail");
        const savedEscrow = localStorage.getItem("ouiNotifierEscrow");
        if (savedEmail) emailField.value = savedEmail;
        if (savedEscrow) {
          escrowField.value = savedEscrow;
          escrowDisplay.textContent = savedEscrow;
          escrowDisplay.href = `https://solscan.io/account/${encodeURIComponent(savedEscrow)}`;
          escrowDisplay.style.visibility = "visible";
        }
      }

      loadOuis();
      loadSavedFields();
    })();
  </script>
</body>
</html>
