<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Helium DC Alerts – OUI Notifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; padding: 2rem; max-width: 700px; margin: 0 auto; }
    h1 { font-size: 1.6rem; margin-bottom: 0.5rem; }
    form { margin-top: 1rem; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #ddd; background: #fafafa; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    input { width: 100%; padding: 0.5rem; margin-bottom: 0.75rem; border-radius: 0.5rem; border: 1px solid #ccc; font-size: 0.95rem; }
    button { padding: 0.6rem 1.2rem; border-radius: 999px; border: none; cursor: pointer; background: #2563eb; color: white; font-weight: 600; }
    button:hover { background: #1d4ed8; }
    small { color: #555; }
    .msg { margin-top: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.9rem; }
    .msg-ok { background: #ecfdf5; color: #064e3b; border: 1px solid #a7f3d0; }
    .msg-err { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
  </style>
</head>
<body>
  <h1>Helium Data Credit Alerts (OUI Notifier)</h1>
  <p>Get email (and optional webhook) alerts when your Helium DC escrow account is projected to run out within 14, 7, or 1 day based on recent burn.</p>
  <p><strong>Note:</strong> Data transfer halts when an escrow hits $35 (≈3,500,000 DC). Alerts and charts treat that as zero.</p>

  <section style="margin-top: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; background: #fff;">
    <h2 style="margin-top: 0; font-size: 1.1rem;">Find your escrow by OUI</h2>
    <p style="margin-top: 0; color: #374151;">Lookup any on-chain OUI to auto-fill the escrow address and see the live DC balance.</p>
    <div style="display: grid; gap: 0.5rem;">
      <div>
        <label for="oui_lookup">OUI</label>
        <input id="oui_lookup" type="number" name="oui_lookup" placeholder="e.g. 3" list="oui-list" form="subscribe_form" />
        <datalist id="oui-list"></datalist>
      </div>
      <div>
        <label for="escrow_account">Escrow token account (Solana)</label>
        <input id="escrow_account" name="escrow_account" type="text" required placeholder="Solana base58 escrow token address" form="subscribe_form" />
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button type="button" id="check_balance">Check live DC balance</button>
        <div id="balance_status" style="font-size: 0.9rem; color: #374151;"></div>
      </div>
    </div>
  </section>

  <!-- The API endpoint is on the Worker at api.heliumtools.org -->
  <form id="subscribe_form" method="POST" action="https://api.heliumtools.org/oui-notifier/subscribe">
    <label for="email">Email address</label>
    <input id="email" name="email" type="email" required placeholder="you@example.com" />

    <label for="label">Label (optional)</label>
    <input id="label" name="label" type="text" placeholder="e.g. Prod IoT OUI" />

    <label for="webhook_url">Webhook URL (optional)</label>
    <input id="webhook_url" name="webhook_url" type="url" placeholder="https://example.com/helium-webhook" />

    <small>We store a daily balance snapshot, estimate your burn over the last 7 days, and email you when you’re about 14, 7, and 1 day from running out.</small>

    <div style="margin-top: 1rem;">
      <button type="submit">Subscribe</button>
    </div>
  </form>

  <script>
    (() => {
      const API_BASE = "https://api.heliumtools.org/oui-notifier";
      const ouiInput = document.getElementById("oui_lookup");
      const escrowInput = document.getElementById("escrow_account");
      const statusEl = document.getElementById("balance_status");
      const checkBtn = document.getElementById("check_balance");
      const datalist = document.getElementById("oui-list");
      let ouiIndex = [];

      function setStatus(text, isError = false) {
        statusEl.textContent = text || "";
        statusEl.style.color = isError ? "#b91c1c" : "#374151";
      }

      function hydrateDatalist(orgs) {
        datalist.innerHTML = "";
        orgs.forEach((org) => {
          const opt = document.createElement("option");
          opt.value = org.oui;
          opt.label = `OUI ${org.oui} • escrow ${org.escrow}`;
          datalist.appendChild(opt);
        });
      }

      function lookupOui(ouiNum) {
        const numericOui = Number(ouiNum);
        if (!Number.isInteger(numericOui)) return null;
        return ouiIndex.find((o) => o.oui === numericOui);
      }

      async function loadOuis() {
        try {
          const res = await fetch(`${API_BASE}/ouis`);
          if (!res.ok) throw new Error("failed to fetch OUIs");
          const data = await res.json();
          ouiIndex = Array.isArray(data.orgs) ? data.orgs : [];
          hydrateDatalist(ouiIndex);
        } catch (err) {
          console.error("Unable to load OUIs", err);
          setStatus("Unable to load OUI list right now.", true);
        }
      }

      async function fetchBalance(params) {
        const query = new URLSearchParams(params);
        const res = await fetch(`${API_BASE}/balance?${query.toString()}`);
        if (!res.ok) throw new Error("failed to fetch balance");
        return res.json();
      }

      async function updateBalance() {
        const escrow = (escrowInput.value || "").trim();
        const ouiValue = (ouiInput.value || "").trim();
        if (!escrow && !ouiValue) {
          setStatus("Enter an escrow address or OUI number.", true);
          return;
        }

        setStatus("Fetching live balance…");
        try {
          const payload = await fetchBalance(
            escrow ? { escrow } : { oui: ouiValue }
          );
          if (payload.error) throw new Error(payload.error);
          const usd = Number(payload.balance_usd || 0);
          const dc = Number(payload.balance_dc || 0);
          setStatus(
            `Live balance: ${dc.toLocaleString("en-US")} DC (~$${usd.toFixed(
              2
            )}). Zeroed at $${payload.zero_balance_usd}.`
          );
        } catch (err) {
          console.error(err);
          setStatus("Could not fetch balance. Please try again.", true);
        }
      }

      ouiInput.addEventListener("change", () => {
        const match = lookupOui(ouiInput.value);
        if (match?.escrow) {
          escrowInput.value = match.escrow;
          setStatus(`Escrow auto-filled for OUI ${match.oui}.`);
          updateBalance();
        }
      });

      checkBtn.addEventListener("click", (ev) => {
        ev.preventDefault();
        updateBalance();
      });

      loadOuis();
    })();
  </script>
</body>
</html>
